<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moodle Category Designer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #48bb78;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .btn-export {
            background: #f59e0b;
            color: white;
        }

        .btn-export:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn-image {
            background: #8b5cf6;
            color: white;
        }

        .btn-image:hover {
            background: #7c3aed;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

        .btn-info:hover {
            background: #0891b2;
            transform: translateY(-2px);
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 14px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid;
        }
        
        .level-1 { background: #dbeafe; border-color: #3b82f6; }
        .level-2 { background: #dcfce7; border-color: #22c55e; }
        .level-3 { background: #f3e8ff; border-color: #a855f7; }
        
        .category {
            margin-bottom: 10px;
        }
        
        .category-content {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid;
            transition: all 0.2s;
            cursor: move;
        }
        
        .category-content:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .category-content.level-1 {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .category-content.level-2 {
            background: #dcfce7;
            border-color: #22c55e;
        }
        
        .category-content.level-3 {
            background: #f3e8ff;
            border-color: #a855f7;
        }

        .category-content.hidden-category {
            opacity: 0.5;
            border-style: dashed;
        }

        .category-content.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .category-content.drag-over {
            border-style: dashed;
            border-width: 3px;
        }

        .category-content.filtered-out {
            display: none;
        }
        
        .expand-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        
        .expand-btn:hover {
            color: #000;
            transform: none;
        }

        .drag-handle {
            cursor: grab;
            color: #999;
            font-size: 18px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }
        
        .category-name {
            flex: 1;
            font-weight: 600;
            font-size: 16px;
        }

        .category-name.hidden-text {
            text-decoration: line-through;
            font-style: italic;
        }
        
        .category-input {
            flex: 1;
            padding: 8px;
            border: 2px solid #3b82f6;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .action-btns {
            display: flex;
            gap: 5px;
        }
        
        .icon-btn {
            padding: 6px;
            border-radius: 6px;
            background: white;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .icon-btn:hover {
            transform: scale(1.1);
        }
        
        .icon-btn.add { color: #22c55e; }
        .icon-btn.edit { color: #3b82f6; }
        .icon-btn.delete { color: #ef4444; }
        .icon-btn.visibility { color: #f59e0b; }
        .icon-btn.info { color: #8b5cf6; }

        .category-details {
            margin-left: 74px;
            margin-top: 8px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 13px;
            align-items: center;
        }

        .category-code {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            font-family: monospace;
        }

        .category-notes {
            background: #f3f4f6;
            color: #4b5563;
            padding: 4px 10px;
            border-radius: 6px;
            font-style: italic;
            max-width: 500px;
        }

        .course-count {
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .course-count:hover {
            background: #c7d2fe;
            transform: scale(1.05);
        }

        .courses-list {
            margin-left: 74px;
            margin-top: 10px;
            background: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid #6366f1;
        }

        .course-item {
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .course-item:hover {
            border-color: #6366f1;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
        }

        .course-item:last-child {
            margin-bottom: 0;
        }

        .course-name {
            flex: 1;
            font-weight: 500;
            color: #374151;
        }

        .course-code-badge {
            background: #fef3c7;
            color: #92400e;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            font-family: monospace;
        }

        .course-notes-badge {
            background: #f3f4f6;
            color: #6b7280;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-style: italic;
        }

        .course-actions {
            display: flex;
            gap: 4px;
        }

        .course-btn {
            padding: 4px 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .course-btn:hover {
            background: #f3f4f6;
        }

        .no-courses {
            text-align: center;
            color: #9ca3af;
            font-style: italic;
            padding: 10px;
        }

        .add-course-btn {
            width: 100%;
            padding: 8px;
            background: transparent;
            color: #6366f1;
            border: 2px dashed #6366f1;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .add-course-btn:hover {
            background: #f0f1ff;
            border-style: solid;
        }
        
        .children {
            margin-left: 40px;
            margin-top: 10px;
            padding-left: 20px;
            border-left: 3px solid #ddd;
        }
        
        .hidden {
            display: none;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 18px;
            z-index: 1000;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #333;
        }

        .modal-body {
            font-size: 16px;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background: #e5e7eb;
            color: #333;
        }

        .modal-btn-cancel:hover {
            background: #d1d5db;
        }

        .modal-btn-confirm {
            background: #ef4444;
            color: white;
        }

        .modal-btn-confirm:hover {
            background: #dc2626;
        }

        .detail-modal .modal-content {
            max-width: 600px;
        }

        .detail-form {
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .file-input {
            display: none;
        }

        .divider {
            width: 2px;
            height: 30px;
            background: #ddd;
            margin: 0 5px;
        }

        .search-results {
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .controls, .legend, h1, .subtitle {
                display: none !important;
            }
            .container {
                box-shadow: none;
                padding: 20px;
            }
            .action-btns, .drag-handle, .expand-btn, .course-actions, .add-course-btn {
                display: none !important;
            }
            .category-content {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎓 Moodle Category Designer</h1>
        <p class="subtitle">Design your category structure with courses</p>
        
        <div class="controls">
            <div class="control-section">
                <button class="btn-primary" onclick="addTopLevel()">➕ Add Top Level</button>
                <button class="btn-info" onclick="expandAll()">📂 Expand All</button>
                <button class="btn-info" onclick="collapseAll()">📁 Collapse All</button>
                <button class="btn-info" onclick="window.print()">🖨️ Print</button>
            </div>
            <div class="divider"></div>
            <div class="control-section">
                <button class="btn-secondary" onclick="saveJSON()">💾 Save</button>
                <button class="btn-secondary" onclick="document.getElementById('loadFile').click()">📂 Load</button>
                <input type="file" id="loadFile" class="file-input" accept=".json" onchange="loadJSON(event)">
            </div>
            <div class="divider"></div>
            <div class="control-section">
                <button class="btn-secondary" onclick="exportTXT()">📄 Text</button>
                <button class="btn-export" onclick="exportCSV()">📊 CSV</button>
                <button class="btn-image" onclick="exportImage()">🖼️ Image</button>
            </div>
        </div>

        <div class="controls">
            <input type="text" id="searchBox" class="search-box" placeholder="🔍 Search categories..." oninput="filterCategories()">
            <span class="search-results" id="searchResults"></span>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-box level-1"></div>
                <span>Level 1</span>
            </div>
            <div class="legend-item">
                <div class="legend-box level-2"></div>
                <span>Level 2</span>
            </div>
            <div class="legend-item">
                <div class="legend-box level-3"></div>
                <span>Level 3</span>
            </div>
            <div class="legend-item">
                <span style="opacity: 0.5">👁️ = Hidden | 📚 = Courses</span>
            </div>
        </div>
        
        <div id="categories"></div>
    </div>

    <script>
        // Moodle Category Designer - Main JavaScript
let categories = [
    {
        id: 1,
        name: 'School of Innovation and Design',
        level: 1,
        expanded: true,
        visible: true,
        code: '',
        notes: '',
        courses: [],
        showCourses: false,
        children: [
            {
                id: 2,
                name: 'Business',
                level: 2,
                expanded: true,
                visible: true,
                code: '',
                notes: '',
                courses: [],
                showCourses: false,
                children: []
            },
            {
                id: 3,
                name: 'IT',
                level: 2,
                expanded: true,
                visible: true,
                code: '',
                notes: '',
                courses: [],
                showCourses: false,
                children: [
                    { id: 4, name: 'Bachelor in IT', level: 3, visible: true, code: '', notes: '', courses: [], showCourses: false },
                    { id: 5, name: 'Certificate in IT', level: 3, visible: true, code: '', notes: '', courses: [], showCourses: false }
                ]
            },
            {
                id: 6,
                name: 'Design',
                level: 2,
                expanded: true,
                visible: true,
                code: '',
                notes: '',
                courses: [],
                showCourses: false,
                children: []
            }
        ]
    }
];

let nextId = 7;
let editingId = null;
let draggedElement = null;
let searchQuery = '';

function autoSave() {
    try {
        const data = {
            version: '1.0',
            categories: categories,
            nextId: nextId,
            savedAt: new Date().toISOString()
        };
        localStorage.setItem('moodleCategoriesAutoSave', JSON.stringify(data));
    } catch (e) {
        console.error('Auto-save failed:', e);
    }
}

function loadAutoSave() {
    try {
        const saved = localStorage.getItem('moodleCategoriesAutoSave');
        if (saved) {
            const data = JSON.parse(saved);
            showConfirmModal(
                'Restore Previous Work?',
                `Found auto-saved work from ${new Date(data.savedAt).toLocaleString()}. Would you like to restore it?`,
                () => {
                    categories = data.categories;
                    nextId = data.nextId;
                    render();
                }
            );
        }
    } catch (e) {
        console.error('Auto-load failed:', e);
    }
}

function triggerAutoSave() {
    autoSave();
    render();
}

function render() {
    const container = document.getElementById('categories');
    container.innerHTML = '';
    categories.forEach(cat => {
        container.appendChild(createCategoryElement(cat));
    });
}

function createCategoryElement(category) {
    const div = document.createElement('div');
    div.className = 'category';
    div.dataset.categoryId = category.id;
    
    const content = document.createElement('div');
    content.className = `category-content level-${category.level}`;
    content.draggable = true;
    
    if (!category.visible) {
        content.classList.add('hidden-category');
    }

    if (searchQuery && !matchesSearch(category)) {
        content.classList.add('filtered-out');
    }

    content.ondragstart = (e) => {
        draggedElement = { id: category.id, level: category.level };
        content.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    };

    content.ondragend = (e) => {
        content.classList.remove('dragging');
        draggedElement = null;
    };

    content.ondragover = (e) => {
        e.preventDefault();
        if (draggedElement && draggedElement.id !== category.id) {
            content.classList.add('drag-over');
        }
    };

    content.ondragleave = (e) => {
        content.classList.remove('drag-over');
    };

    content.ondrop = (e) => {
        e.preventDefault();
        content.classList.remove('drag-over');
        if (draggedElement && draggedElement.id !== category.id) {
            moveCategory(draggedElement.id, category.id);
        }
    };

    const dragHandle = document.createElement('span');
    dragHandle.className = 'drag-handle';
    dragHandle.innerHTML = '⋮⋮';
    dragHandle.title = 'Drag to reorder';
    content.appendChild(dragHandle);
    
    // Always show expand button if category has children OR courses
    if (category.level < 3 || category.courses.length > 0) {
        const expandBtn = document.createElement('button');
        expandBtn.className = 'expand-btn';
        expandBtn.innerHTML = category.expanded ? '▼' : '▶';
        expandBtn.onclick = () => toggleExpand(category.id);
        content.appendChild(expandBtn);
    }
    
    if (editingId === category.id) {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'category-input';
        input.value = category.name;
        input.onblur = () => saveEdit(category.id, input.value);
        input.onkeypress = (e) => {
            if (e.key === 'Enter') saveEdit(category.id, input.value);
        };
        content.appendChild(input);
        setTimeout(() => input.focus(), 0);
    } else {
        const name = document.createElement('span');
        name.className = 'category-name';
        if (!category.visible) {
            name.classList.add('hidden-text');
        }
        name.textContent = category.name;
        content.appendChild(name);
    }
    
    const actions = document.createElement('div');
    actions.className = 'action-btns';
    
    if (category.level < 3) {
        const addBtn = document.createElement('button');
        addBtn.className = 'icon-btn add';
        addBtn.textContent = '➕';
        addBtn.title = 'Add subcategory';
        addBtn.onclick = () => addChild(category.id, category.level + 1);
        actions.appendChild(addBtn);
    }

    const visBtn = document.createElement('button');
    visBtn.className = 'icon-btn visibility';
    visBtn.textContent = category.visible ? '👁️' : '🚫';
    visBtn.title = category.visible ? 'Hide in Moodle' : 'Show in Moodle';
    visBtn.onclick = () => toggleVisibility(category.id);
    actions.appendChild(visBtn);

    const infoBtn = document.createElement('button');
    infoBtn.className = 'icon-btn info';
    infoBtn.textContent = '📝';
    infoBtn.title = 'Add code & notes';
    infoBtn.onclick = () => showDetailsModal(category.id);
    actions.appendChild(infoBtn);

    const coursesBtn = document.createElement('button');
    coursesBtn.className = 'icon-btn info';
    coursesBtn.textContent = '📚';
    coursesBtn.title = 'Manage courses';
    coursesBtn.onclick = () => {
        toggleCourses(category.id);
        // Also expand if not already expanded
        const cat = findCategoryById(category.id);
        if (cat && !cat.expanded) {
            toggleExpand(category.id);
        }
    };
    actions.appendChild(coursesBtn);
    
    const editBtn = document.createElement('button');
    editBtn.className = 'icon-btn edit';
    editBtn.textContent = '✏️';
    editBtn.title = 'Edit';
    editBtn.onclick = () => startEdit(category.id);
    actions.appendChild(editBtn);
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'icon-btn delete';
    deleteBtn.textContent = '❌';
    deleteBtn.title = 'Delete';
    deleteBtn.onclick = () => deleteCategory(category.id);
    actions.appendChild(deleteBtn);
    
    content.appendChild(actions);
    div.appendChild(content);

    if ((category.code || category.notes || category.courses.length > 0) && editingId !== category.id) {
        const details = document.createElement('div');
        details.className = 'category-details';
        
        if (category.code) {
            const code = document.createElement('span');
            code.className = 'category-code';
            code.textContent = `Code: ${category.code}`;
            details.appendChild(code);
        }
        
        if (category.notes) {
            const notes = document.createElement('span');
            notes.className = 'category-notes';
            notes.textContent = `📌 ${category.notes}`;
            details.appendChild(notes);
        }

        if (category.courses.length > 0) {
            const courseCount = document.createElement('span');
            courseCount.className = 'course-count';
            courseCount.textContent = `📚 ${category.courses.length} course${category.courses.length !== 1 ? 's' : ''}`;
            courseCount.title = 'Click to show/hide courses';
            courseCount.onclick = () => toggleExpand(category.id);
            details.appendChild(courseCount);
        }
        
        div.appendChild(details);
    }

    // Show courses if expanded (for all levels)
    if (category.expanded && (category.showCourses || category.courses.length > 0)) {
        const coursesList = document.createElement('div');
        coursesList.className = 'courses-list';
        
        if (category.courses.length > 0) {
            category.courses.forEach(course => {
                const courseItem = document.createElement('div');
                courseItem.className = 'course-item';
                courseItem.draggable = true;
                courseItem.dataset.courseId = course.id;

                // Drag events for courses
                courseItem.ondragstart = (e) => {
                    e.stopPropagation();
                    courseItem.style.opacity = '0.5';
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('courseId', course.id);
                    e.dataTransfer.setData('categoryId', category.id);
                };

                courseItem.ondragend = (e) => {
                    courseItem.style.opacity = '1';
                };

                courseItem.ondragover = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    courseItem.style.borderTop = '3px solid #6366f1';
                };

                courseItem.ondragleave = (e) => {
                    courseItem.style.borderTop = '1px solid #e5e7eb';
                };

                courseItem.ondrop = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    courseItem.style.borderTop = '1px solid #e5e7eb';
                    
                    const draggedCourseId = parseInt(e.dataTransfer.getData('courseId'));
                    const draggedCategoryId = parseInt(e.dataTransfer.getData('categoryId'));
                    
                    if (draggedCategoryId === category.id && draggedCourseId !== course.id) {
                        reorderCourse(category.id, draggedCourseId, course.id);
                    }
                };

                // Drag handle for courses
                const courseDragHandle = document.createElement('span');
                courseDragHandle.style.cssText = 'cursor: grab; color: #999; font-size: 14px; margin-right: 5px;';
                courseDragHandle.innerHTML = '⋮⋮';
                courseDragHandle.title = 'Drag to reorder';
                courseItem.appendChild(courseDragHandle);
                
                const courseName = document.createElement('span');
                courseName.className = 'course-name';
                courseName.textContent = course.name;
                courseItem.appendChild(courseName);
                
                if (course.code) {
                    const courseCode = document.createElement('span');
                    courseCode.className = 'course-code-badge';
                    courseCode.textContent = course.code;
                    courseItem.appendChild(courseCode);
                }
                
                if (course.notes) {
                    const courseNotes = document.createElement('span');
                    courseNotes.className = 'course-notes-badge';
                    courseNotes.textContent = course.notes;
                    courseItem.appendChild(courseNotes);
                }
                
                const courseActions = document.createElement('div');
                courseActions.className = 'course-actions';
                
                const editCourseBtn = document.createElement('button');
                editCourseBtn.className = 'course-btn';
                editCourseBtn.textContent = '✏️';
                editCourseBtn.title = 'Edit course';
                editCourseBtn.onclick = () => showCourseModal(category.id, course.id);
                courseActions.appendChild(editCourseBtn);
                
                const deleteCourseBtn = document.createElement('button');
                deleteCourseBtn.className = 'course-btn';
                deleteCourseBtn.textContent = '❌';
                deleteCourseBtn.title = 'Delete course';
                deleteCourseBtn.onclick = () => deleteCourse(category.id, course.id);
                courseActions.appendChild(deleteCourseBtn);
                
                courseItem.appendChild(courseActions);
                coursesList.appendChild(courseItem);
            });
        } else {
            const noCourses = document.createElement('div');
            noCourses.className = 'no-courses';
            noCourses.textContent = 'No courses yet';
            coursesList.appendChild(noCourses);
        }
        
        const addCourseBtn = document.createElement('button');
        addCourseBtn.className = 'add-course-btn';
        addCourseBtn.innerHTML = '+ Add Course';
        addCourseBtn.onclick = () => showCourseModal(category.id);
        coursesList.appendChild(addCourseBtn);
        
        div.appendChild(coursesList);
    }
    
    if (category.children && category.children.length > 0 && category.expanded) {
        const childrenDiv = document.createElement('div');
        childrenDiv.className = 'children';
        category.children.forEach(child => {
            childrenDiv.appendChild(createCategoryElement(child));
        });
        div.appendChild(childrenDiv);
    }
    
    return div;
}

function matchesSearch(category) {
    if (!searchQuery) return true;
    const query = searchQuery.toLowerCase();
    if (category.name.toLowerCase().includes(query)) return true;
    if (category.children) {
        return category.children.some(child => matchesSearch(child));
    }
    return false;
}

function findCategoryById(id) {
    let found = null;
    const search = (cats) => {
        for (let cat of cats) {
            if (cat.id === id) {
                found = cat;
                return true;
            }
            if (cat.children && search(cat.children)) {
                return true;
            }
        }
        return false;
    };
    search(categories);
    return found;
}

function filterCategories() {
    searchQuery = document.getElementById('searchBox').value;
    
    let matchCount = 0;
    const countMatches = (cats) => {
        cats.forEach(cat => {
            if (cat.name.toLowerCase().includes(searchQuery.toLowerCase())) {
                matchCount++;
            }
            if (cat.children) countMatches(cat.children);
        });
    };
    countMatches(categories);

    document.getElementById('searchResults').textContent = 
        searchQuery ? `${matchCount} match${matchCount !== 1 ? 'es' : ''} found` : '';
    
    render();
}

function moveCategory(draggedId, targetId) {
    let draggedCategory = null;
    const removeDragged = (cats) => {
        for (let i = 0; i < cats.length; i++) {
            if (cats[i].id === draggedId) {
                draggedCategory = cats.splice(i, 1)[0];
                return true;
            }
            if (cats[i].children && removeDragged(cats[i].children)) {
                return true;
            }
        }
        return false;
    };
    removeDragged(categories);

    if (!draggedCategory) return;

    const insertBefore = (cats) => {
        for (let i = 0; i < cats.length; i++) {
            if (cats[i].id === targetId) {
                draggedCategory.level = cats[i].level;
                cats.splice(i, 0, draggedCategory);
                return true;
            }
            if (cats[i].children && insertBefore(cats[i].children)) {
                return true;
            }
        }
        return false;
    };

    if (!insertBefore(categories)) {
        categories.push(draggedCategory);
    }

    triggerAutoSave();
}

function toggleVisibility(id) {
    const toggle = (cats) => {
        return cats.map(cat => {
            if (cat.id === id) {
                const newVisible = !cat.visible;
                const cascadeVisibility = (children) => {
                    if (!children) return children;
                    return children.map(child => ({
                        ...child,
                        visible: newVisible,
                        children: cascadeVisibility(child.children)
                    }));
                };
                return { 
                    ...cat, 
                    visible: newVisible,
                    children: cascadeVisibility(cat.children)
                };
            }
            if (cat.children) {
                return { ...cat, children: toggle(cat.children) };
            }
            return cat;
        });
    };
    categories = toggle(categories);
    triggerAutoSave();
}

function toggleExpand(id) {
    const toggle = (cats) => {
        return cats.map(cat => {
            if (cat.id === id) {
                return { ...cat, expanded: !cat.expanded };
            }
            if (cat.children) {
                return { ...cat, children: toggle(cat.children) };
            }
            return cat;
        });
    };
    categories = toggle(categories);
    triggerAutoSave();
}

function expandAll() {
    const expand = (cats) => {
        return cats.map(cat => ({
            ...cat,
            expanded: true,
            children: cat.children ? expand(cat.children) : []
        }));
    };
    categories = expand(categories);
    triggerAutoSave();
}

function collapseAll() {
    const collapse = (cats) => {
        return cats.map(cat => ({
            ...cat,
            expanded: false,
            children: cat.children ? collapse(cat.children) : []
        }));
    };
    categories = collapse(categories);
    triggerAutoSave();
}

function addTopLevel() {
    categories.push({
        id: nextId++,
        name: 'New Category',
        level: 1,
        expanded: true,
        visible: true,
        code: '',
        notes: '',
        courses: [],
        showCourses: false,
        children: []
    });
    triggerAutoSave();
}

function addChild(parentId, level) {
    const add = (cats) => {
        return cats.map(cat => {
            if (cat.id === parentId) {
                return {
                    ...cat,
                    expanded: true,
                    children: [...cat.children, {
                        id: nextId++,
                        name: 'New Category',
                        level: level,
                        expanded: true,
                        visible: true,
                        code: '',
                        notes: '',
                        courses: [],
                        showCourses: false,
                        children: []
                    }]
                };
            }
            if (cat.children) {
                return { ...cat, children: add(cat.children) };
            }
            return cat;
        });
    };
    categories = add(categories);
    triggerAutoSave();
}

function startEdit(id) {
    editingId = id;
    render();
}

function saveEdit(id, newName) {
    const update = (cats) => {
        return cats.map(cat => {
            if (cat.id === id) {
                return { ...cat, name: newName };
            }
            if (cat.children) {
                return { ...cat, children: update(cat.children) };
            }
            return cat;
        });
    };
    categories = update(categories);
    editingId = null;
    triggerAutoSave();
}

function deleteCategory(id) {
    showConfirmModal(
        'Delete Category?',
        'Are you sure you want to delete this category and all its subcategories? This action cannot be undone.',
        () => {
            const remove = (cats) => {
                return cats.filter(cat => cat.id !== id).map(cat => {
                    if (cat.children) {
                        return { ...cat, children: remove(cat.children) };
                    }
                    return cat;
                });
            };
            categories = remove(categories);
            triggerAutoSave();
        }
    );
}

function showDetailsModal(categoryId) {
    let targetCategory = null;
    const findCategory = (cats) => {
        for (let cat of cats) {
            if (cat.id === categoryId) {
                targetCategory = cat;
                return true;
            }
            if (cat.children && findCategory(cat.children)) {
                return true;
            }
        }
        return false;
    };
    findCategory(categories);

    if (!targetCategory) return;

    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay detail-modal';
    
    const modal = document.createElement('div');
    modal.className = 'modal-content';
    
    const header = document.createElement('div');
    header.className = 'modal-header';
    header.textContent = `📝 ${targetCategory.name}`;
    
    const form = document.createElement('div');
    form.className = 'detail-form';
    
    const codeGroup = document.createElement('div');
    codeGroup.className = 'form-group';
    const codeLabel = document.createElement('label');
    codeLabel.className = 'form-label';
    codeLabel.textContent = 'Category Code (e.g., BUS, IT, DES)';
    const codeInput = document.createElement('input');
    codeInput.className = 'form-input';
    codeInput.type = 'text';
    codeInput.value = targetCategory.code || '';
    codeInput.placeholder = 'Optional short code';
    codeGroup.appendChild(codeLabel);
    codeGroup.appendChild(codeInput);
    
    const notesGroup = document.createElement('div');
    notesGroup.className = 'form-group';
    const notesLabel = document.createElement('label');
    notesLabel.className = 'form-label';
    notesLabel.textContent = 'Notes / Comments';
    const notesInput = document.createElement('textarea');
    notesInput.className = 'form-input form-textarea';
    notesInput.value = targetCategory.notes || '';
    notesInput.placeholder = 'Add notes, course counts, migration plans, etc...';
    notesGroup.appendChild(notesLabel);
    notesGroup.appendChild(notesInput);
    
    form.appendChild(codeGroup);
    form.appendChild(notesGroup);
    
    const actions = document.createElement('div');
    actions.className = 'modal-actions';
    
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'modal-btn modal-btn-cancel';
    cancelBtn.textContent = 'Cancel';
    cancelBtn.onclick = () => document.body.removeChild(overlay);
    
    const saveBtn = document.createElement('button');
    saveBtn.className = 'modal-btn modal-btn-confirm';
    saveBtn.style.background = '#667eea';
    saveBtn.textContent = 'Save';
    saveBtn.onclick = () => {
        updateCategoryDetails(categoryId, codeInput.value.trim(), notesInput.value.trim());
        document.body.removeChild(overlay);
    };
    
    actions.appendChild(cancelBtn);
    actions.appendChild(saveBtn);
    
    modal.appendChild(header);
    modal.appendChild(form);
    modal.appendChild(actions);
    overlay.appendChild(modal);
    
    overlay.onclick = (e) => {
        if (e.target === overlay) {
            document.body.removeChild(overlay);
        }
    };
    
    const handleEscape = (e) => {
        if (e.key === 'Escape') {
            document.body.removeChild(overlay);
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);
    
    document.body.appendChild(overlay);
    codeInput.focus();
}

function updateCategoryDetails(id, code, notes) {
    const update = (cats) => {
        return cats.map(cat => {
            if (cat.id === id) {
                return { ...cat, code, notes };
            }
            if (cat.children) {
                return { ...cat, children: update(cat.children) };
            }
            return cat;
        });
    };
    categories = update(categories);
    triggerAutoSave();
}

function toggleCourses(categoryId) {
    const toggle = (cats) => {
        return cats.map(cat => {
            if (cat.id === categoryId) {
                return { ...cat, showCourses: !cat.showCourses };
            }
            if (cat.children) {
                return { ...cat, children: toggle(cat.children) };
            }
            return cat;
        });
    };
    categories = toggle(categories);
    render();
}

function showCourseModal(categoryId, courseId = null) {
    let targetCategory = null;
    const findCategory = (cats) => {
        for (let cat of cats) {
            if (cat.id === categoryId) {
                targetCategory = cat;
                return true;
            }
            if (cat.children && findCategory(cat.children)) {
                return true;
            }
        }
        return false;
    };
    findCategory(categories);

    if (!targetCategory) return;

    const existingCourse = courseId ? targetCategory.courses.find(c => c.id === courseId) : null;
    const isEdit = !!existingCourse;

    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay detail-modal';
    
    const modal = document.createElement('div');
    modal.className = 'modal-content';
    
    const header = document.createElement('div');
    header.className = 'modal-header';
    header.textContent = isEdit ? `✏️ Edit Course` : `➕ Add Course to ${targetCategory.name}`;
    
    const form = document.createElement('div');
    form.className = 'detail-form';
    
    const nameGroup = document.createElement('div');
    nameGroup.className = 'form-group';
    const nameLabel = document.createElement('label');
    nameLabel.className = 'form-label';
    nameLabel.textContent = 'Course Name *';
    const nameInput = document.createElement('input');
    nameInput.className = 'form-input';
    nameInput.type = 'text';
    nameInput.value = existingCourse ? existingCourse.name : '';
    nameInput.placeholder = 'e.g., Introduction to Business';
    nameInput.required = true;
    nameGroup.appendChild(nameLabel);
    nameGroup.appendChild(nameInput);
    
    const codeGroup = document.createElement('div');
    codeGroup.className = 'form-group';
    const codeLabel = document.createElement('label');
    codeLabel.className = 'form-label';
    codeLabel.textContent = 'Course Code (e.g., BUS101)';
    const codeInput = document.createElement('input');
    codeInput.className = 'form-input';
    codeInput.type = 'text';
    codeInput.value = existingCourse ? existingCourse.code : '';
    codeInput.placeholder = 'Optional course code';
    codeGroup.appendChild(codeLabel);
    codeGroup.appendChild(codeInput);
    
    const notesGroup = document.createElement('div');
    notesGroup.className = 'form-group';
    const notesLabel = document.createElement('label');
    notesLabel.className = 'form-label';
    notesLabel.textContent = 'Notes / Comments';
    const notesInput = document.createElement('input');
    notesInput.className = 'form-input';
    notesInput.type = 'text';
    notesInput.value = existingCourse ? existingCourse.notes : '';
    notesInput.placeholder = 'e.g., Migrate from old system, 50 students';
    notesGroup.appendChild(notesLabel);
    notesGroup.appendChild(notesInput);
    
    form.appendChild(nameGroup);
    form.appendChild(codeGroup);
    form.appendChild(notesGroup);
    
    const actions = document.createElement('div');
    actions.className = 'modal-actions';
    
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'modal-btn modal-btn-cancel';
    cancelBtn.textContent = 'Cancel';
    cancelBtn.onclick = () => document.body.removeChild(overlay);
    
    const saveBtn = document.createElement('button');
    saveBtn.className = 'modal-btn modal-btn-confirm';
    saveBtn.style.background = '#667eea';
    saveBtn.textContent = isEdit ? 'Update' : 'Add Course';
    saveBtn.onclick = () => {
        const name = nameInput.value.trim();
        if (!name) {
            alert('Course name is required');
            return;
        }
        if (isEdit) {
            updateCourse(categoryId, courseId, name, codeInput.value.trim(), notesInput.value.trim());
        } else {
            addCourse(categoryId, name, codeInput.value.trim(), notesInput.value.trim());
        }
        document.body.removeChild(overlay);
    };
    
    actions.appendChild(cancelBtn);
    actions.appendChild(saveBtn);
    
    modal.appendChild(header);
    modal.appendChild(form);
    modal.appendChild(actions);
    overlay.appendChild(modal);
    
    overlay.onclick = (e) => {
        if (e.target === overlay) {
            document.body.removeChild(overlay);
        }
    };
    
    const handleEscape = (e) => {
        if (e.key === 'Escape') {
            document.body.removeChild(overlay);
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);
    
    document.body.appendChild(overlay);
    nameInput.focus();
}

function addCourse(categoryId, name, code, notes) {
    const update = (cats) => {
        return cats.map(cat => {
            if (cat.id === categoryId) {
                const newCourse = {
                    id: Date.now(),
                    name: name,
                    code: code,
                    notes: notes
                };
                return { ...cat, courses: [...cat.courses, newCourse], showCourses: true };
            }
            if (cat.children) {
                return { ...cat, children: update(cat.children) };
            }
            return cat;
        });
    };
    categories = update(categories);
    triggerAutoSave();
}

function updateCourse(categoryId, courseId, name, code, notes) {
    const update = (cats) => {
        return cats.map(cat => {
            if (cat.id === categoryId) {
                const updatedCourses = cat.courses.map(course => 
                    course.id === courseId ? { ...course, name, code, notes } : course
                );
                return { ...cat, courses: updatedCourses };
            }
            if (cat.children) {
                return { ...cat, children: update(cat.children) };
            }
            return cat;
        });
    };
    categories = update(categories);
    triggerAutoSave();
}

function deleteCourse(categoryId, courseId) {
    showConfirmModal(
        'Delete Course?',
        'Are you sure you want to delete this course?',
        () => {
            const update = (cats) => {
                return cats.map(cat => {
                    if (cat.id === categoryId) {
                        return { ...cat, courses: cat.courses.filter(c => c.id !== courseId) };
                    }
                    if (cat.children) {
                        return { ...cat, children: update(cat.children) };
                    }
                    return cat;
                });
            };
            categories = update(categories);
            triggerAutoSave();
        }
    );
}

function reorderCourse(categoryId, draggedCourseId, targetCourseId) {
    const update = (cats) => {
        return cats.map(cat => {
            if (cat.id === categoryId) {
                const courses = [...cat.courses];
                const draggedIndex = courses.findIndex(c => c.id === draggedCourseId);
                const targetIndex = courses.findIndex(c => c.id === targetCourseId);
                
                if (draggedIndex !== -1 && targetIndex !== -1) {
                    const [draggedCourse] = courses.splice(draggedIndex, 1);
                    courses.splice(targetIndex, 0, draggedCourse);
                }
                
                return { ...cat, courses };
            }
            if (cat.children) {
                return { ...cat, children: update(cat.children) };
            }
            return cat;
        });
    };
    categories = update(categories);
    triggerAutoSave();
}

function showConfirmModal(title, message, onConfirm) {
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    
    const modal = document.createElement('div');
    modal.className = 'modal-content';
    
    const header = document.createElement('div');
    header.className = 'modal-header';
    header.textContent = title;
    
    const body = document.createElement('div');
    body.className = 'modal-body';
    body.textContent = message;
    
    const actions = document.createElement('div');
    actions.className = 'modal-actions';
    
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'modal-btn modal-btn-cancel';
    cancelBtn.textContent = 'Cancel';
    cancelBtn.onclick = () => document.body.removeChild(overlay);
    
    const confirmBtn = document.createElement('button');
    confirmBtn.className = 'modal-btn modal-btn-confirm';
    confirmBtn.textContent = title.includes('Delete') ? 'Delete' : 'Yes';
    confirmBtn.onclick = () => {
        onConfirm();
        document.body.removeChild(overlay);
    };
    
    actions.appendChild(cancelBtn);
    actions.appendChild(confirmBtn);
    
    modal.appendChild(header);
    modal.appendChild(body);
    modal.appendChild(actions);
    overlay.appendChild(modal);
    
    overlay.onclick = (e) => {
        if (e.target === overlay) {
            document.body.removeChild(overlay);
        }
    };
    
    const handleEscape = (e) => {
        if (e.key === 'Escape') {
            document.body.removeChild(overlay);
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);
    
    document.body.appendChild(overlay);
}

function saveJSON() {
    const data = {
        version: '1.0',
        categories: categories,
        nextId: nextId
    };
    const json = JSON.stringify(data, null, 2);
    downloadFile(json, 'moodle-categories.json', 'application/json');
}

function loadJSON(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            categories = data.categories || data;
            nextId = data.nextId || getMaxId(categories) + 1;
            triggerAutoSave();
        } catch (error) {
            alert('Error loading file: ' + error.message);
        }
    };
    reader.readAsText(file);
}

function getMaxId(cats) {
    let maxId = 0;
    const findMax = (items) => {
        items.forEach(item => {
            if (item.id > maxId) maxId = item.id;
            if (item.children) findMax(item.children);
        });
    };
    findMax(cats);
    return maxId;
}

function exportTXT() {
    const format = (cats, indent = 0) => {
        let result = '';
        cats.forEach(cat => {
            const visibility = cat.visible ? '' : ' [HIDDEN]';
            const code = cat.code ? ` (${cat.code})` : '';
            const notes = cat.notes ? ` - ${cat.notes}` : '';
            const courseCount = cat.courses.length > 0 ? ` [${cat.courses.length} courses]` : '';
            result += '  '.repeat(indent) + '- ' + cat.name + code + visibility + courseCount + notes + '\n';
            
            if (cat.courses.length > 0) {
                cat.courses.forEach(course => {
                    const courseCode = course.code ? ` (${course.code})` : '';
                    const courseNotes = course.notes ? ` - ${course.notes}` : '';
                    result += '  '.repeat(indent + 1) + '  * ' + course.name + courseCode + courseNotes + '\n';
                });
            }
            
            if (cat.children && cat.children.length > 0) {
                result += format(cat.children, indent + 1);
            }
        });
        return result;
    };
    
    const text = 'Moodle Category Structure\n' + '='.repeat(30) + '\n\n' + format(categories);
    downloadFile(text, 'moodle-categories.txt', 'text/plain');
}

function exportCSV() {
    let csv = 'Type,Level,Category Path,Name,Parent,Visible,Code,Notes\n';
    
    const flatten = (cats, path = [], parentName = '') => {
        cats.forEach(cat => {
            const currentPath = [...path, cat.name];
            const pathStr = currentPath.join(' > ');
            const visible = cat.visible ? 'Yes' : 'No';
            const code = cat.code || '';
            const notes = (cat.notes || '').replace(/"/g, '""');
            csv += `Category,${cat.level},"${pathStr}","${cat.name}","${parentName}","${visible}","${code}","${notes}"\n`;
            
            cat.courses.forEach(course => {
                const courseCode = course.code || '';
                const courseNotes = (course.notes || '').replace(/"/g, '""');
                csv += `Course,${cat.level},"${pathStr}","${course.name}","${cat.name}","Yes","${courseCode}","${courseNotes}"\n`;
            });
            
            if (cat.children && cat.children.length > 0) {
                flatten(cat.children, currentPath, cat.name);
            }
        });
    };
    
    flatten(categories);
    downloadFile(csv, 'moodle-categories.csv', 'text/csv');
}

async function exportImage() {
    const loading = document.createElement('div');
    loading.className = 'loading';
    loading.textContent = 'Generating presentation image...';
    document.body.appendChild(loading);

    const presentationDiv = createPresentationView();
    document.body.appendChild(presentationDiv);

    await new Promise(resolve => setTimeout(resolve, 300));

    try {
        const canvas = await html2canvas(presentationDiv, {
            backgroundColor: '#ffffff',
            scale: 2,
            logging: false,
            width: presentationDiv.offsetWidth,
            height: presentationDiv.offsetHeight
        });
        
        canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'moodle-categories.png';
            a.click();
            URL.revokeObjectURL(url);
            
            document.body.removeChild(presentationDiv);
            document.body.removeChild(loading);
        });
    } catch (error) {
        alert('Error generating image: ' + error.message);
        document.body.removeChild(presentationDiv);
        document.body.removeChild(loading);
    }
}

function createPresentationView() {
    const container = document.createElement('div');
    container.style.cssText = `
        position: fixed;
        left: -9999px;
        top: 0;
        width: 1400px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 60px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    `;

    const content = document.createElement('div');
    content.style.cssText = `
        background: white;
        border-radius: 20px;
        padding: 50px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    `;

    const header = document.createElement('div');
    header.style.cssText = `
        text-align: center;
        margin-bottom: 40px;
        padding-bottom: 30px;
        border-bottom: 3px solid #667eea;
    `;
    header.innerHTML = `
        <h1 style="font-size: 42px; color: #333; margin-bottom: 10px;">🎓 Moodle Category Structure</h1>
        <p style="font-size: 18px; color: #666;">Generated on ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
    `;
    content.appendChild(header);

    const legend = document.createElement('div');
    legend.style.cssText = `
        display: flex;
        justify-content: center;
        gap: 40px;
        margin-bottom: 40px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
    `;
    legend.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; font-size: 16px;">
            <div style="width: 30px; height: 30px; background: #dbeafe; border: 3px solid #3b82f6; border-radius: 6px;"></div>
            <span style="font-weight: 600;">Level 1 - Top Categories</span>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; font-size: 16px;">
            <div style="width: 30px; height: 30px; background: #dcfce7; border: 3px solid #22c55e; border-radius: 6px;"></div>
            <span style="font-weight: 600;">Level 2 - Departments</span>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; font-size: 16px;">
            <div style="width: 30px; height: 30px; background: #f3e8ff; border: 3px solid #a855f7; border-radius: 6px;"></div>
            <span style="font-weight: 600;">Level 3 - Programs</span>
        </div>
    `;
    content.appendChild(legend);

    const tree = document.createElement('div');
    tree.style.cssText = 'margin-top: 30px;';
    
    categories.forEach((cat, index) => {
        tree.appendChild(createPresentationCategory(cat, 0));
        if (index < categories.length - 1) {
            const spacer = document.createElement('div');
            spacer.style.cssText = 'height: 30px;';
            tree.appendChild(spacer);
        }
    });
    
    content.appendChild(tree);

    const footer = document.createElement('div');
    footer.style.cssText = `
        margin-top: 40px;
        padding-top: 20px;
        border-top: 2px solid #e5e7eb;
        text-align: center;
        color: #999;
        font-size: 14px;
    `;
    footer.innerHTML = `
        <p>Total Categories: ${countAllCategories()} | Created with Moodle Category Designer</p>
    `;
    content.appendChild(footer);

    container.appendChild(content);
    return container;
}

function createPresentationCategory(category, depth) {
    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'margin-bottom: 15px;';

    const item = document.createElement('div');
    item.style.cssText = `
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 18px 25px;
        border-radius: 12px;
        margin-left: ${depth * 50}px;
        font-size: 18px;
        font-weight: 600;
        position: relative;
        ${category.level === 1 ? 'background: #dbeafe; border: 3px solid #3b82f6;' : ''}
        ${category.level === 2 ? 'background: #dcfce7; border: 3px solid #22c55e;' : ''}
        ${category.level === 3 ? 'background: #f3e8ff; border: 3px solid #a855f7;' : ''}
        ${!category.visible ? 'opacity: 0.6; border-style: dashed;' : ''}
    `;

    if (depth > 0) {
        const connector = document.createElement('div');
        connector.style.cssText = `
            position: absolute;
            left: ${depth * 50 - 25}px;
            top: 50%;
            width: 25px;
            height: 2px;
            background: #cbd5e1;
        `;
        item.appendChild(connector);
    }

    const icon = document.createElement('span');
    icon.style.cssText = 'font-size: 24px;';
    icon.textContent = category.level === 1 ? '🏛️' : category.level === 2 ? '📚' : '📖';
    item.appendChild(icon);

    const name = document.createElement('span');
    name.style.cssText = !category.visible ? 'text-decoration: line-through; font-style: italic;' : '';
    name.textContent = category.name;
    if (category.code) {
        name.textContent += ` (${category.code})`;
    }
    item.appendChild(name);

    if (category.courses.length > 0) {
        const courseCountBadge = document.createElement('span');
        courseCountBadge.style.cssText = `
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        `;
        courseCountBadge.textContent = `${category.courses.length} courses`;
        item.appendChild(courseCountBadge);
    }

    if (!category.visible) {
        const hiddenBadge = document.createElement('span');
        hiddenBadge.style.cssText = `
            background: #fbbf24;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        `;
        hiddenBadge.textContent = 'Hidden';
        item.appendChild(hiddenBadge);
    }

    wrapper.appendChild(item);

    if (category.notes) {
        const notesBadge = document.createElement('div');
        notesBadge.style.cssText = `
            margin-left: ${depth * 50 + 50}px;
            margin-top: 8px;
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 400;
            font-style: italic;
            color: #4b5563;
        `;
        notesBadge.textContent = `📌 ${category.notes}`;
        wrapper.appendChild(notesBadge);
    }

    if (category.courses.length > 0) {
        const coursesSection = document.createElement('div');
        coursesSection.style.cssText = `
            margin-left: ${depth * 50 + 50}px;
            margin-top: 10px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 3px solid #6366f1;
        `;
        
        category.courses.forEach(course => {
            const courseItem = document.createElement('div');
            courseItem.style.cssText = `
                padding: 6px 10px;
                background: white;
                border-radius: 6px;
                margin-bottom: 6px;
                font-size: 14px;
                color: #374151;
            `;
            
            let courseText = `📖 ${course.name}`;
            if (course.code) courseText += ` (${course.code})`;
            if (course.notes) courseText += ` - ${course.notes}`;
            
            courseItem.textContent = courseText;
            coursesSection.appendChild(courseItem);
        });
        
        wrapper.appendChild(coursesSection);
    }

    if (category.children && category.children.length > 0) {
        const childrenWrapper = document.createElement('div');
        childrenWrapper.style.cssText = `
            margin-top: 10px;
            position: relative;
        `;
        
        if (category.children.length > 0) {
            const verticalLine = document.createElement('div');
            verticalLine.style.cssText = `
                position: absolute;
                left: ${depth * 50 + 25}px;
                top: 0;
                bottom: 20px;
                width: 2px;
                background: #cbd5e1;
            `;
            childrenWrapper.appendChild(verticalLine);
        }

        category.children.forEach(child => {
            childrenWrapper.appendChild(createPresentationCategory(child, depth + 1));
        });
        wrapper.appendChild(childrenWrapper);
    }

    return wrapper;
}

function countAllCategories() {
    let count = 0;
    const countRecursive = (cats) => {
        cats.forEach(cat => {
            count++;
            if (cat.children) countRecursive(cat.children);
        });
    };
    countRecursive(categories);
    return count;
}

function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

window.addEventListener('load', () => {
    loadAutoSave();
});

render();
    </script>
</body>
</html>
